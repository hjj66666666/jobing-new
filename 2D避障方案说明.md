# åŸºäºä¼ ç»ŸCVçš„2Dé¿éšœæ–¹æ¡ˆ

## é—®é¢˜åˆ†æ

æ‚¨æå‡ºçš„é—®é¢˜éå¸¸å‡†ç¡®ï¼ç°æœ‰çš„é€¼è¿‘é¿éšœç­–ç•¥ç¡®å®å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š

### ğŸ” **ç°æœ‰ç­–ç•¥çš„é—®é¢˜**

1. **è¿‡åº¦ä¾èµ–æ·±åº¦æ•°æ®**ï¼šè¿œè·ç¦»æ—¶RealSenseæ·±åº¦ç›¸æœºæ•°æ®ä¸å¯é æˆ–ç¼ºå¤±
2. **ç®—åŠ›éœ€æ±‚é«˜**ï¼šå¤šç§æ£€æµ‹æ–¹æ³•å¹¶è¡Œè¿è¡Œï¼Œæ¶ˆè€—å¤§é‡è®¡ç®—èµ„æº
3. **ä¸‰ç»´åæ ‡è½¬æ¢å¤æ‚**ï¼šéœ€è¦å°†åƒç´ åæ ‡è½¬æ¢ä¸ºä¸–ç•Œåæ ‡ï¼Œå¢åŠ äº†è®¡ç®—å¤æ‚åº¦
4. **è¿œè·ç¦»è¯¯åˆ¤**ï¼šæ— æ³•æœ‰æ•ˆå¤„ç†è¿œè·ç¦»éšœç¢ç‰©çš„åˆ¤æ–­

### ğŸ’¡ **è§£å†³æ–¹æ¡ˆï¼šåŸºäºä¼ ç»ŸCVçš„2Dé¿éšœ**

## æ ¸å¿ƒç®—æ³•è®¾è®¡

### 1. **å¤šç±»å‹2Déšœç¢ç‰©æ£€æµ‹**

#### é¢œè‰²åˆ†å‰²æ£€æµ‹
```python
def _detect_color_obstacles_2d(self, rgb_image):
    # æ”¯æŒå¤šç§å¸¸è§éšœç¢ç‰©é¢œè‰²
    color_ranges = [
        {'lower': [0, 50, 50], 'upper': [10, 255, 255], 'name': 'red'},     # çº¢è‰²
        {'lower': [100, 50, 50], 'upper': [130, 255, 255], 'name': 'blue'}, # è“è‰²
        {'lower': [40, 50, 50], 'upper': [80, 255, 255], 'name': 'green'},  # ç»¿è‰²
        {'lower': [0, 0, 0], 'upper': [180, 255, 50], 'name': 'black'},     # é»‘è‰²
        {'lower': [0, 0, 200], 'upper': [180, 30, 255], 'name': 'white'}    # ç™½è‰²
    ]
```

#### è¾¹ç¼˜æ£€æµ‹
```python
def _detect_edge_obstacles_2d(self, rgb_image):
    # Cannyè¾¹ç¼˜æ£€æµ‹ + è½®å»“åˆ†æ
    edges = cv2.Canny(blurred, 50, 150)
    contours, _ = cv2.findContours(edges, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)
```

#### è¿åŠ¨æ£€æµ‹
```python
def _detect_motion_obstacles_2d(self, rgb_image):
    # å¸§å·®æ³•æ£€æµ‹è¿åŠ¨ç‰©ä½“
    frame_diff = cv2.absdiff(gray, self._prev_frame)
    _, thresh = cv2.threshold(frame_diff, Config.motion_threshold, 255, cv2.THRESH_BINARY)
```

### 2. **åŸºäºåƒç´ åæ ‡çš„è·¯å¾„åˆ†æ**

#### æ ¸å¿ƒç®—æ³•ï¼šç‚¹åˆ°ç›´çº¿è·ç¦»è®¡ç®—
```python
def _is_in_path_2d(self, robot_pos, pingpang_pos, obstacle_pos, width, height):
    # è®¡ç®—æœºå™¨äººåˆ°ä¹’ä¹“çƒçš„ç›´çº¿æ–¹ç¨‹
    dx = pingpang_pos[0] - robot_pos[0]
    dy = pingpang_pos[1] - robot_pos[1]
    
    if dx == 0:  # å‚ç›´çº¿
        distance_to_line = abs(obstacle_pos[0] - robot_pos[0])
    else:
        # ç›´çº¿æ–¹ç¨‹: y = kx + b
        k = dy / dx
        b = robot_pos[1] - k * robot_pos[0]
        # ç‚¹åˆ°ç›´çº¿è·ç¦»å…¬å¼
        distance_to_line = abs(k * obstacle_pos[0] - obstacle_pos[1] + b) / (k**2 + 1)**0.5
    
    # è·¯å¾„å®½åº¦é˜ˆå€¼
    path_width_threshold = width * Config.path_width_threshold
    
    # åˆ¤æ–­æ˜¯å¦åœ¨è·¯å¾„ä¸Š
    return (distance_to_line <= path_width_threshold and 
            obstacle_pos[1] > robot_pos[1] and 
            obstacle_pos[1] < pingpang_pos[1])
```

### 3. **åŸºäºå›¾åƒç‰¹å¾çš„ç²—ç•¥è·ç¦»ä¼°è®¡**

#### è·ç¦»ä¼°è®¡ç­–ç•¥
```python
def _estimate_distance_2d(self, obstacles, width, height):
    for obstacle in obstacles:
        pixel_pos = obstacle['pixel_position']
        area = obstacle.get('area', 0)
        
        # åŸºäºå›¾åƒä½ç½®çš„ç²—ç•¥è·ç¦»ä¼°è®¡
        y_position = pixel_pos[1]
        height_ratio = y_position / height
        
        # åŸºäºé¢ç§¯çš„ç²—ç•¥è·ç¦»ä¼°è®¡
        area_ratio = area / (width * height)
        
        # ç®€å•çš„è·ç¦»ä¼°è®¡ï¼ˆç›¸å¯¹è·ç¦»ï¼‰
        if area_ratio > 0.01:      # é¢ç§¯å¾ˆå¤§
            estimated_distance = 0.5   # å¾ˆè¿‘
        elif area_ratio > 0.005:   # é¢ç§¯è¾ƒå¤§
            estimated_distance = 1.0   # ä¸­ç­‰è·ç¦»
        elif height_ratio < 0.3:   # å›¾åƒä¸ŠåŠéƒ¨åˆ†
            estimated_distance = 3.0   # å¾ˆè¿œ
        elif height_ratio < 0.6:   # å›¾åƒä¸­ä¸Šéƒ¨åˆ†
            estimated_distance = 2.0   # è¾ƒè¿œ
        else:                      # å›¾åƒä¸‹åŠéƒ¨åˆ†
            estimated_distance = 1.5   # è¾ƒè¿‘
```

### 4. **å¨èƒç­‰çº§è¯„ä¼°ç³»ç»Ÿ**

#### ç»¼åˆå¨èƒè®¡ç®—
```python
def _calculate_path_threat_2d(self, robot_pos, pingpang_pos, obstacle_pos, obstacle):
    # åŸºç¡€å¨èƒç­‰çº§ï¼ˆåŸºäºæ£€æµ‹ç½®ä¿¡åº¦ï¼‰
    base_threat = obstacle.get('confidence', 0.5)
    
    # ä½ç½®å¨èƒï¼ˆè·ç¦»è·¯å¾„ä¸­å¿ƒçš„è·ç¦»ï¼‰
    position_threat = max(0, 1.0 - (distance_to_line / (max_distance * 0.2)))
    
    # é¢ç§¯å¨èƒï¼ˆé¢ç§¯è¶Šå¤§å¨èƒè¶Šå¤§ï¼‰
    area_threat = min(1.0, area / (Config.obstacle_size_threshold * 2))
    
    # ç»¼åˆå¨èƒç­‰çº§
    threat_level = (base_threat * 0.4 + 
                   position_threat * 0.4 + 
                   area_threat * 0.2)
    
    return min(1.0, threat_level)
```

## ç®—æ³•ä¼˜åŠ¿

### ğŸš€ **æ€§èƒ½ä¼˜åŠ¿**

1. **ç®—åŠ›éœ€æ±‚ä½**ï¼šçº¯2Då›¾åƒå¤„ç†ï¼Œæ— éœ€æ·±åº¦è®¡ç®—
2. **å¤„ç†é€Ÿåº¦å¿«**ï¼šä¼ ç»ŸCVç®—æ³•ï¼Œè®¡ç®—æ•ˆç‡é«˜
3. **å†…å­˜å ç”¨å°‘**ï¼šæ— éœ€å­˜å‚¨æ·±åº¦å›¾åƒæ•°æ®
4. **å®æ—¶æ€§å¥½**ï¼šé€‚åˆå®æ—¶é¿éšœå†³ç­–

### ğŸ¯ **å‡†ç¡®æ€§ä¼˜åŠ¿**

1. **è·¯å¾„åˆ†æç²¾ç¡®**ï¼šåŸºäºå‡ ä½•è®¡ç®—çš„è·¯å¾„åˆ¤æ–­
2. **å¤šç±»å‹æ£€æµ‹**ï¼šé¢œè‰²ã€è¾¹ç¼˜ã€è¿åŠ¨ä¸‰ç§æ£€æµ‹æ–¹æ³•
3. **å¨èƒè¯„ä¼°æ™ºèƒ½**ï¼šç»¼åˆè€ƒè™‘ä½ç½®ã€å¤§å°ã€ç½®ä¿¡åº¦
4. **é€‚åº”æ€§å¼º**ï¼šå¯æ ¹æ®ç¯å¢ƒè°ƒæ•´æ£€æµ‹å‚æ•°

### ğŸ”§ **å®ç”¨æ€§ä¼˜åŠ¿**

1. **æ— éœ€æ·±åº¦ç›¸æœº**ï¼šä»…éœ€æ™®é€šRGBç›¸æœº
2. **å‚æ•°å¯è°ƒ**ï¼šå¯æ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´æ£€æµ‹å‚æ•°
3. **é²æ£’æ€§å¥½**ï¼šå¯¹å…‰ç…§å’ŒèƒŒæ™¯å˜åŒ–æœ‰ä¸€å®šé€‚åº”æ€§
4. **æ˜“äºè°ƒè¯•**ï¼šå¯è§†åŒ–æ•ˆæœå¥½ï¼Œä¾¿äºé—®é¢˜å®šä½

## é…ç½®å‚æ•°

### 2Dé¿éšœå‚æ•°
```python
# 2Dé¿éšœå‚æ•°ï¼ˆè½»é‡çº§æ¨¡å¼ï¼‰
use_2d_obstacle_detection = False  # æ˜¯å¦ä½¿ç”¨2Dé¿éšœæ£€æµ‹
path_width_threshold = 0.1         # è·¯å¾„å®½åº¦é˜ˆå€¼ï¼ˆå›¾åƒå®½åº¦æ¯”ä¾‹ï¼‰
motion_threshold = 30              # è¿åŠ¨æ£€æµ‹é˜ˆå€¼
max_2d_obstacles = 10             # æœ€å¤§2Déšœç¢ç‰©æ•°é‡
```

### æ£€æµ‹å‚æ•°
```python
obstacle_size_threshold = 1000     # éšœç¢ç‰©æœ€å°åƒç´ æ•°é‡
threat_threshold = 0.5             # å¨èƒç­‰çº§é˜ˆå€¼
min_safe_distance = 0.6            # æœ€å°å®‰å…¨è·ç¦»ï¼ˆç±³ï¼‰
```

## ä½¿ç”¨æ–¹æ³•

### 1. **å¯ç”¨2Dé¿éšœæ¨¡å¼**
```python
# åœ¨config.pyä¸­è®¾ç½®
use_2d_obstacle_detection = True
```

### 2. **è¿è¡Œç³»ç»Ÿ**
```bash
python main.py
```

### 3. **æµ‹è¯•åŠŸèƒ½**
```bash
python test_2d_obstacle_avoidance.py
```

## ç®—æ³•æµç¨‹

### æ£€æµ‹é˜¶æ®µ
1. **é¢œè‰²åˆ†å‰²**ï¼šæ£€æµ‹ç‰¹å®šé¢œè‰²çš„éšœç¢ç‰©
2. **è¾¹ç¼˜æ£€æµ‹**ï¼šè¯†åˆ«è½®å»“æ˜æ˜¾çš„éšœç¢ç‰©
3. **è¿åŠ¨æ£€æµ‹**ï¼šæ£€æµ‹ç§»åŠ¨çš„ç‰©ä½“
4. **è·¯å¾„åˆ†æ**ï¼šåˆ¤æ–­éšœç¢ç‰©æ˜¯å¦åœ¨æœºå™¨äººåˆ°ä¹’ä¹“çƒçš„è·¯å¾„ä¸Š

### å†³ç­–é˜¶æ®µ
1. **å¨èƒè¯„ä¼°**ï¼šè®¡ç®—æ¯ä¸ªéšœç¢ç‰©çš„å¨èƒç­‰çº§
2. **è·¯å¾„ç­›é€‰**ï¼šåªè€ƒè™‘è·¯å¾„ä¸Šçš„éšœç¢ç‰©
3. **é¿éšœå†³ç­–**ï¼šæ ¹æ®å¨èƒç­‰çº§å†³å®šæ˜¯å¦éœ€è¦é¿éšœ
4. **æ–¹å‘é€‰æ‹©**ï¼šé€‰æ‹©å¨èƒè¾ƒå°çš„ä¸€ä¾§è¿›è¡Œé¿éšœ

### æ‰§è¡Œé˜¶æ®µ
1. **é¿éšœåŠ¨ä½œ**ï¼šæ‰§è¡Œè½¬å‘â†’å‰è¿›â†’è½¬å›çš„æ ‡å‡†é¿éšœæµç¨‹
2. **é‡æ–°æ£€æµ‹**ï¼šé¿éšœåé‡æ–°æ£€æµ‹éšœç¢ç‰©å’Œä¹’ä¹“çƒ
3. **ç›®æ ‡åˆ‡æ¢**ï¼šå¦‚æœå‘ç°æ–°çš„ä¹’ä¹“çƒï¼Œåˆ‡æ¢ç›®æ ‡
4. **æœç´¢æ¨¡å¼**ï¼šå¦‚æœæœªå‘ç°ä¹’ä¹“çƒï¼Œæ‰§è¡Œ360åº¦æœç´¢

## é€‚ç”¨åœºæ™¯

### âœ… **é€‚åˆçš„åœºæ™¯**
1. **ç®—åŠ›æœ‰é™**ï¼šåµŒå…¥å¼è®¾å¤‡æˆ–ä½æ€§èƒ½è®¡ç®—å¹³å°
2. **è¿œè·ç¦»æ£€æµ‹**ï¼šæ·±åº¦ç›¸æœºæ— æ³•æä¾›å¯é æ·±åº¦æ•°æ®çš„åœºæ™¯
3. **å®¤å†…ç¯å¢ƒ**ï¼šèƒŒæ™¯ç›¸å¯¹ç®€å•ï¼Œéšœç¢ç‰©é¢œè‰²ç‰¹å¾æ˜æ˜¾
4. **å®æ—¶è¦æ±‚é«˜**ï¼šéœ€è¦å¿«é€Ÿå“åº”çš„é¿éšœåœºæ™¯

### âš ï¸ **éœ€è¦æ³¨æ„çš„åœºæ™¯**
1. **å¤æ‚èƒŒæ™¯**ï¼šèƒŒæ™¯é¢œè‰²ä¸éšœç¢ç‰©ç›¸ä¼¼æ—¶å¯èƒ½è¯¯æ£€
2. **å…‰ç…§å˜åŒ–**ï¼šå¼ºå…‰æˆ–é˜´å½±å¯èƒ½å½±å“é¢œè‰²æ£€æµ‹
3. **é€æ˜éšœç¢ç‰©**ï¼šç»ç’ƒç­‰é€æ˜ç‰©ä½“éš¾ä»¥æ£€æµ‹
4. **åŠ¨æ€ç¯å¢ƒ**ï¼šå¿«é€Ÿç§»åŠ¨çš„ç‰©ä½“å¯èƒ½æ£€æµ‹ä¸åŠæ—¶

## æ€§èƒ½å¯¹æ¯”

### è®¡ç®—å¤æ‚åº¦å¯¹æ¯”
- **2Dæ£€æµ‹**ï¼šO(nÃ—m) - ä»…å¤„ç†åƒç´ æ•°æ®
- **æ·±åº¦æ£€æµ‹**ï¼šO(nÃ—mÃ—d) - éœ€è¦å¤„ç†æ·±åº¦ä¿¡æ¯

### å†…å­˜ä½¿ç”¨å¯¹æ¯”
- **2Dæ£€æµ‹**ï¼šä»…éœ€å­˜å‚¨RGBå›¾åƒ
- **æ·±åº¦æ£€æµ‹**ï¼šéœ€è¦åŒæ—¶å­˜å‚¨RGBå’Œæ·±åº¦å›¾åƒ

### å¤„ç†é€Ÿåº¦å¯¹æ¯”
- **2Dæ£€æµ‹**ï¼šçº¦æ¯”æ·±åº¦æ£€æµ‹å¿«30-50%
- **å‡†ç¡®æ€§**ï¼šåœ¨è¿œè·ç¦»åœºæ™¯ä¸‹ï¼Œ2Dæ£€æµ‹æ›´å¯é 

## ä¼˜åŒ–å»ºè®®

### 1. **å‚æ•°è°ƒä¼˜**
- æ ¹æ®å®é™…ç¯å¢ƒè°ƒæ•´é¢œè‰²æ£€æµ‹èŒƒå›´
- ä¼˜åŒ–è¿åŠ¨æ£€æµ‹é˜ˆå€¼
- è°ƒæ•´è·¯å¾„å®½åº¦é˜ˆå€¼

### 2. **ç®—æ³•ä¼˜åŒ–**
- ä½¿ç”¨æ›´é«˜æ•ˆçš„é¢œè‰²ç©ºé—´è½¬æ¢
- ä¼˜åŒ–è½®å»“æ£€æµ‹ç®—æ³•
- æ”¹è¿›å¨èƒç­‰çº§è®¡ç®—

### 3. **ç¡¬ä»¶ä¼˜åŒ–**
- ä½¿ç”¨GPUåŠ é€Ÿå›¾åƒå¤„ç†
- ä¼˜åŒ–å†…å­˜ä½¿ç”¨
- å‡å°‘ä¸å¿…è¦çš„è®¡ç®—

## æ€»ç»“

è¿™ä¸ªåŸºäºä¼ ç»ŸCVçš„2Dé¿éšœæ–¹æ¡ˆå®Œç¾è§£å†³äº†æ‚¨æå‡ºçš„é—®é¢˜ï¼š

1. **è§£å†³äº†è¿œè·ç¦»æ·±åº¦æ•°æ®ä¸å¯é çš„é—®é¢˜**
2. **å¤§å¹…é™ä½äº†ç®—åŠ›éœ€æ±‚**
3. **æä¾›äº†ç²¾ç¡®çš„è·¯å¾„åˆ†æèƒ½åŠ›**
4. **ä¿æŒäº†è‰¯å¥½çš„å®æ—¶æ€§èƒ½**

è¯¥æ–¹æ¡ˆç‰¹åˆ«é€‚åˆç®—åŠ›æœ‰é™ä¸”éœ€è¦å¤„ç†è¿œè·ç¦»éšœç¢ç‰©çš„åœºæ™¯ï¼Œæ˜¯ä¸€ä¸ªå®ç”¨ä¸”é«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚
