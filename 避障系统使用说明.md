# 乒乓球捡取系统 - 障碍物避障功能使用说明

## 概述

本系统实现了基于OpenCV和深度相机的智能障碍物检测和避障功能，能够自动识别乒乓球到摄像头之间的障碍物，并执行智能避障策略。系统通过深度信息验证障碍物的真实距离，避免因二维视觉造成的误判。

## 主要功能

### 1. 障碍物检测（深度信息验证版）
- **深度检测**: 使用RealSense深度相机检测近距离关键障碍物
- **颜色检测**: 基于HSV颜色空间检测特定颜色的障碍物，并通过深度信息验证
- **边缘检测**: 使用Canny边缘检测算法识别轮廓障碍物，结合深度数据过滤
- **深度过滤**: 所有检测结果都通过深度信息验证，避免远距离物体误判
- **关键性分级**: 根据距离和威胁程度对障碍物进行关键性分级
- **多类型融合**: 综合多种检测方法，提高检测准确性和可靠性

### 2. 智能避障策略（威胁等级评估）
- **路径分析**: 分析乒乓球到机器人的路径上是否存在障碍物
- **威胁等级计算**: 基于距离、位置、关键性和置信度计算障碍物威胁等级
- **智能决策**: 只有当威胁等级超过阈值时才执行避障动作
- **方向选择**: 根据障碍物分布智能选择避障方向（左转或右转）
- **避障动作**: 执行转向→前进→转回的标准避障流程
- **新目标发现**: 避障过程中如果发现新的乒乓球，立即切换目标

### 3. 360度搜索
- **原地搜索**: 当未检测到乒乓球时，执行360度原地搜索
- **慢速旋转**: 使用较慢的旋转速度，确保检测准确性
- **实时检测**: 搜索过程中持续进行乒乓球检测
- **自动停止**: 一旦发现乒乓球立即停止搜索

## 配置参数

### 车辆参数
```python
vehicle_width = 300          # 车辆宽度（毫米）
vehicle_length = 400         # 车辆长度（毫米）
vehicle_safety_margin = 100  # 车辆安全边距（毫米）
```

### 避障参数
```python
min_safe_distance = 0.6           # 最小安全距离（米）
obstacle_size_threshold = 1000    # 障碍物最小像素数量
max_avoidance_attempts = 3        # 最大避障尝试次数
avoidance_turn_time = 1.0         # 避障转向时间（秒）
avoidance_move_time = 0.8         # 避障前进时间（秒）
threat_threshold = 0.5            # 威胁等级阈值
```

### 深度检测参数
```python
min_detection_distance = 0.1      # 最小检测距离（米）
max_detection_distance = 3.0      # 最大检测距离（米）
depth_confidence_threshold = 0.3  # 深度检测置信度阈值
```

### 搜索参数
```python
search_speed = 0.3                # 360度搜索时的速度
search_rotation_angle = 10        # 每次旋转角度（度）
search_rotation_interval = 0.5    # 旋转间隔（秒）
```

## 使用方法

### 1. 自动模式（推荐）
```python
# 在config.py中设置
mode = 0  # 自动捡球模式

# 系统会自动检测乒乓球和障碍物，执行智能避障
```

### 2. 手动模式
```python
# 在config.py中设置
mode = 1  # 手动回车捡球模式

# 按回车键开始带避障的自动逼近
```

### 3. 运行系统
```bash
python main.py
```

## 避障流程

### 1. 检测阶段
1. 使用YOLO模型检测乒乓球
2. 使用OpenCV检测障碍物
3. 分析路径上的障碍物分布

### 2. 决策阶段
1. 判断是否有障碍物阻挡路径
2. 计算最优避障方向
3. 选择避障策略

### 3. 执行阶段
1. 执行避障动作（转向→前进→转回）
2. 重新检测乒乓球和障碍物
3. 如果发现新乒乓球，切换目标
4. 如果未发现乒乓球，执行360度搜索

### 4. 逼近阶段
1. 无障碍物时执行正常逼近
2. 调整位置和距离
3. 到达目标位置后执行抓取

## 障碍物类型（深度信息验证版）

系统可以检测以下类型的障碍物，所有障碍物都通过深度信息验证：

### 深度障碍物
- 检测原理：基于深度相机的距离信息
- 置信度：0.9（最高）
- 关键性：自动标记为关键障碍物
- 显示颜色：红色，关键障碍物有绿色外圈

### 颜色障碍物
- 检测原理：基于HSV颜色空间 + 深度验证
- 支持颜色：红色、蓝色、绿色
- 置信度：0.3-0.8（根据距离调整）
- 关键性：距离 < 安全距离时标记为关键
- 显示颜色：黄色，关键障碍物有绿色外圈

### 边缘障碍物
- 检测原理：基于Canny边缘检测 + 深度验证
- 置信度：0.2-0.6（根据距离调整）
- 关键性：距离 < 安全距离时标记为关键
- 显示颜色：紫色，关键障碍物有绿色外圈

### 威胁等级评估
系统根据以下因素计算威胁等级：
- **距离威胁**（40%权重）：距离越近威胁越大
- **位置威胁**（30%权重）：距离路径中心越近威胁越大
- **关键性威胁**（20%权重）：关键障碍物威胁更大
- **置信度威胁**（10%权重）：置信度越高威胁越大

## 测试功能

### 运行测试脚本
```bash
python test_obstacle_avoidance.py
```

### 测试项目
1. **障碍物检测测试（深度验证）**: 验证基于深度信息的障碍物检测功能
2. **基于深度的避障决策测试**: 验证威胁等级计算和避障决策算法
3. **360度搜索测试**: 验证原地搜索功能
4. **传统避障逻辑测试**: 验证基础避障决策算法

## 故障排除

### 常见问题

1. **检测不到障碍物**
   - 检查深度相机是否正常工作
   - 调整`min_safe_distance`参数
   - 检查环境光线条件
   - 验证深度检测范围设置（`min_detection_distance`和`max_detection_distance`）

2. **误判远距离障碍物**
   - 调整`max_detection_distance`参数，限制检测范围
   - 降低`threat_threshold`参数，提高避障决策阈值
   - 检查深度相机的校准状态

3. **避障动作过于频繁**
   - 增加`threat_threshold`参数
   - 调整`min_safe_distance`参数
   - 检查障碍物检测的准确性和深度验证

4. **关键障碍物识别不准确**
   - 调整`min_safe_distance`参数
   - 检查深度相机的精度和稳定性
   - 验证障碍物检测的置信度设置

5. **360度搜索速度过快**
   - 降低`search_speed`参数
   - 增加`search_rotation_interval`参数

6. **避障后找不到乒乓球**
   - 检查避障动作的时间参数
   - 调整`avoidance_move_time`参数
   - 确保搜索范围足够大

### 调试模式

在`config.py`中启用调试模式：
```python
debug_mode = True
```

这将输出详细的调试信息，帮助分析问题。

## 性能优化

### 1. 检测精度优化
- 根据实际环境调整颜色检测范围
- 优化深度检测的阈值参数
- 调整边缘检测的Canny参数

### 2. 响应速度优化
- 减少不必要的图像处理
- 优化避障动作的时间参数
- 调整搜索间隔时间

### 3. 稳定性优化
- 增加障碍物检测的置信度阈值
- 优化重复障碍物过滤算法
- 改进路径分析算法

## 扩展功能

### 1. 自定义障碍物类型
可以通过修改`obstacle_classes`参数来添加新的障碍物类型。

### 2. 动态参数调整
可以根据环境条件动态调整避障参数。

### 3. 多目标跟踪
可以扩展系统支持多个乒乓球目标的跟踪和选择。

## 注意事项

1. **安全第一**: 确保避障参数设置合理，避免碰撞
2. **环境适应**: 根据实际使用环境调整检测参数
3. **定期测试**: 定期运行测试脚本验证系统功能
4. **参数备份**: 修改参数前备份原始配置

## 技术支持

如果遇到问题，请：
1. 查看控制台输出的调试信息
2. 运行测试脚本进行诊断
3. 检查配置文件参数设置
4. 联系技术支持团队
