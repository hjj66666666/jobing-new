# 乒乓球捡取系统 - 双模式切换功能

## 功能概述

本系统实现了基于检测结果的双模式切换功能，在远距离使用云端视觉识别+延长移动时间，在近距离使用本地YOLO识别+正常移动时间，以解决云端识别延迟较长的问题。

## 工作原理

1. **检测模式切换**：
   - 当连续5次未检测到乒乓球时，系统自动切换到云端识别模式
   - 一旦检测到乒乓球，立即切换回本地识别模式

2. **移动时间调整**：
   - 保持移动速度不变，只在云端识别模式下增加移动时间（默认为2倍）
   - 这样可以确保在云端识别模式下，车辆移动更加稳定，避免因识别延迟导致的过冲

3. **云端视觉增强**：
   - 在云端识别模式下，系统会调用云端视觉API进行远距离乒乓球检测
   - 云端API返回的结果会与本地检测结果合并，提高检测成功率

4. **车辆移动状态管理**：
   - 系统会实时更新车辆的移动状态（移动/停止）
   - 在车辆停止状态下，如果连续未检测到乒乓球，会触发云端视觉增强

## 关键参数

- `max_consecutive_no_detection`: 触发云端模式的连续未检测次数阈值（默认5次）
- `move_time_multiplier`: 云端模式下的移动时间倍数（默认2.0）
- `cloud_vision_interval`: 云端视觉API调用的最小间隔（默认1秒）

## 使用方法

系统会自动根据检测结果切换模式，无需手动干预。在控制台和图像界面上会显示当前的检测模式、移动时间倍数和连续未检测次数等信息。

## 项目概述

本项目是一个基于计算机视觉的乒乓球捡取系统，使用RealSense深度相机检测乒乓球，并控制机器人进行捡取。

## 系统特点

- 使用RealSense深度相机进行乒乓球检测
- 支持实时3D坐标计算
- 支持自动逼近和抓取
- 支持云端决策系统
- 支持云端视觉增强（远距离乒乓球检测）

## 云端视觉增强功能

系统新增了云端视觉增强功能，用于解决远距离乒乓球检测精度不足的问题。当本地模型无法在远距离（默认超过2米）识别乒乓球时，系统会自动将图像帧通过API接口传给云端的视觉模型进行检测，然后返回到本地完成逼近，直到本地模型能够实现识别。

### 工作流程

1. 本地模型进行乒乓球检测
2. 如果检测到的乒乓球距离超过阈值（默认2米）或未检测到乒乓球，触发云端视觉增强
3. 将RGB图像和深度图像发送到云端服务器
4. 云端服务器使用更高级的模型进行远距离乒乓球检测
5. 云端服务器返回检测结果（包括边界框和3D坐标）
6. 本地系统合并云端结果和本地结果
7. 使用合并后的结果进行逼近和抓取

### 配置参数

在`config/config.py`中添加了以下配置参数：

```python
# 云端视觉增强配置
use_cloud_vision = True  # 是否使用云端视觉增强
cloud_vision_endpoint = "http://localhost:8000/api/vision"  # 云端视觉API端点
cloud_vision_threshold = 2.0  # 使用云端视觉的距离阈值（米）
cloud_vision_interval = 1.0  # 云端视觉请求间隔（秒）
cloud_vision_confidence = 0.3  # 云端视觉检测置信度阈值
cloud_vision_max_size = 640  # 发送到云端的图像最大尺寸（像素）
```

### 命令行参数

可以通过以下命令行参数控制云端视觉增强功能：

```bash
# 启用云端视觉增强
python main.py --cloud-vision

# 禁用云端视觉增强
python main.py --no-cloud-vision

# 设置云端视觉API端点
python main.py --vision-endpoint http://your-server:8000/api/vision

# 设置云端视觉距离阈值
python main.py --vision-threshold 2.5

# 设置云端视觉请求间隔
python main.py --vision-interval 0.5
```

### 键盘控制

- `C键`：手动触发云端视觉增强
- `V键`：切换云端视觉增强状态（启用/禁用）

## 安装与运行

### 依赖安装

```bash
pip install -r requirements.txt
```

### 运行系统

```bash
python main.py
```

## 系统架构

- `main.py`：主程序入口
- `modules/vision.py`：视觉处理模块
- `modules/controller.py`：控制器模块
- `modules/hardware.py`：硬件接口模块
- `config/config.py`：配置文件
- `cloud_server.py`：云端服务器
- `cloud_decision.py`：云端决策系统
